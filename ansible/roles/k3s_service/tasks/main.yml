---
- name: Validate required variables
  ansible.builtin.include_tasks: assert-vars.yml
- name: Namespace
  kubernetes.core.k8s:
    name: "{{ k3s_service_namespace }}"
    api_version: v1
    kind: Namespace
- name: Set module defaults
  module_defaults:
    kubernetes.core.k8s:
      namespace: "{{ k3s_service_namespace }}"
      apply: true
  block:
    - name: "Debug"
      ansible.builtin.debug:
        var: rendered_template
      vars:
        rendered_template: "{{ lookup('template', item.template) | regex_replace('\\n', '\n    ') }}"
      loop: "{{ k3s_service_config_files }}"
    - name: "ConfigMaps"
      kubernetes.core.k8s:
        state: present
        template: "configmap.yml.j2"
    - name: '"persistent" StorageClass (basic localpath for persistent volumes)'
      kubernetes.core.k8s:
        state: present
        template: "persistent-storage-class.yaml.j2"
    - name: "Storage"
      kubernetes.core.k8s:
        state: "{{ k3s_service_state }}"
        template: "storage.yaml.j2"
    - name: "Deployment"
      kubernetes.core.k8s:
        state: "{{ k3s_service_state }}"
        template: "deployment.yaml.j2"
    - name: "Service"
      kubernetes.core.k8s:
        state: "{{ k3s_service_state }}"
        template: "service.yaml.j2"
    - name: "Ingress"
      kubernetes.core.k8s:
        state: "{{ k3s_service_state }}"
        template: "ingress.yaml.j2"

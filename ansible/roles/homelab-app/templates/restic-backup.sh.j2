#!/bin/bash
set -euo pipefail

export RESTIC_REPOSITORY="rclone:{{ homelab_app_backups_rclone_remote }}/{{ homelab_app_name }}/{{ item.volume }}"
export RESTIC_PASSWORD='{{ homelab_app_backups_restic_password }}'
export RESTIC_CACHE_DIR="{{ homelab_app_backups_restic_cache_dir }}"
export RCLONE_CONFIG_DIR="{{ homelab_app_backups_rclone_conf_target_dir }}"
export RESTIC_HOST="{{ homelab_app_name }}-{{ item.volume }}"
CONTAINER="{{ homelab_app_name }}"

echo "[restic] Stopping container $CONTAINER..."
if docker ps -q -f name="^/${CONTAINER}$" | grep -q .; then
  docker stop "$CONTAINER"
else
  echo "[restic] Warning: container $CONTAINER not running"
fi

# Define a cleanup function to always restart container
cleanup() {
  echo "[restic] Restarting container $CONTAINER..."
  docker start "$CONTAINER" || echo "[restic] Failed to restart $CONTAINER"
}
trap cleanup EXIT

echo "[restic] Starting backup of volume {{ item.volume }} for app {{ homelab_app_name }}"
if ! docker run --rm \
  -v {{ homelab_app_name }}-{{ item.volume }}:/data:ro \
  -v "$RCLONE_CONFIG_DIR:/root/.config/rclone:ro" \
  -v "$RESTIC_CACHE_DIR:/root/.cache/restic" \
  -v /etc/localtime:/etc/localtime:ro \
  -e RESTIC_REPOSITORY \
  -e RESTIC_PASSWORD \
  -e RESTIC_HOST \
  homelab-restic-rclone:latest \
  backup /data; then
  echo "[restic] ERROR: backup failed for {{ homelab_app_name }}/{{ item.volume }}"
{% if homelab_app_backups_webhook_url is defined and homelab_app_backups_webhook_url %}
  curl -X POST "{{ homelab_app_backups_webhook_url }}" \
    -H "Content-Type: application/json" \
    -d "{\"content\":\"<@314453725647208449> Backup failed for {{ homelab_app_name }}/{{ item.volume }}: restic backup failed\"}" \
    --max-time 10 || echo "[restic] Failed to send webhook notification"
{% endif %}
  exit 1
fi

echo "[restic] Applying retention policy (daily={{ item.retention_daily | default(homelab_app_backups_retention_daily) }}, weekly={{ item.retention_weekly | default(homelab_app_backups_retention_weekly) }}, monthly={{ item.retention_monthly | default(homelab_app_backups_retention_monthly) }}, yearly={{ item.retention_yearly | default(homelab_app_backups_retention_yearly) }})"
if ! docker run --rm \
  -v "$RCLONE_CONFIG_DIR:/root/.config/rclone:ro" \
  -v "$RESTIC_CACHE_DIR:/root/.cache/restic" \
  -v /etc/localtime:/etc/localtime:ro \
  -e RESTIC_REPOSITORY \
  -e RESTIC_PASSWORD \
  -e RESTIC_HOST \
  homelab-restic-rclone:latest \
  forget --keep-daily {{ item.retention_daily | default(homelab_app_backups_retention_daily) }} \
    --keep-weekly {{ item.retention_weekly | default(homelab_app_backups_retention_weekly) }} \
    --keep-monthly {{ item.retention_monthly | default(homelab_app_backups_retention_monthly) }} \
    --keep-yearly {{ item.retention_yearly | default(homelab_app_backups_retention_yearly) }} \
    --prune; then
  echo "[restic] ERROR: retention policy failed for {{ homelab_app_name }}/{{ item.volume }}"
{% if homelab_app_backups_webhook_url is defined and homelab_app_backups_webhook_url %}
  curl -X POST "{{ homelab_app_backups_webhook_url }}" \
    -H "Content-Type: application/json" \
    -d "{\"content\":\"<@314453725647208449> Backup failed for {{ homelab_app_name }}/{{ item.volume }}: restic retention policy failed\"}" \
    --max-time 10 || echo "[restic] Failed to send webhook notification"
{% endif %}
  exit 1
fi

{% if homelab_app_restic_stats_directory %}
echo "[restic] Collecting repository statistics..."
mkdir -p "{{ homelab_app_restic_stats_directory }}/{{ homelab_app_name }}"
docker run --rm \
  -v "$RCLONE_CONFIG_DIR:/root/.config/rclone:ro" \
  -v "$RESTIC_CACHE_DIR:/root/.cache/restic" \
  -v /etc/localtime:/etc/localtime:ro \
  -e RESTIC_REPOSITORY \
  -e RESTIC_PASSWORD \
  homelab-restic-rclone:latest \
  stats --mode raw-data --json > "{{ homelab_app_restic_stats_directory }}/{{ homelab_app_name }}/{{ item.volume }}-stats.json"
{% endif %}

echo "[restic] Backup for {{ homelab_app_name }}/{{ item.volume }} completed."

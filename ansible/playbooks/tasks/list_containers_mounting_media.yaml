- name: Find all compose files
  find:
    paths: /srv/apps
    patterns: "compose.yml"
    recurse: true
  register: compose_files

- name: Read compose files
  slurp:
    path: "{{ item.path }}"
  loop: "{{ compose_files.files }}"
  register: compose_contents

- name: Initialize empty list
  set_fact:
    media_apps: []

- name: Check each compose file for /mnt/media
  set_fact:
    media_apps: "{{ media_apps + [item.item.path | dirname] }}"
  loop: "{{ compose_contents.results }}"
  when: "'/mnt/media' in (item.content | b64decode)"

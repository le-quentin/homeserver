---
- name: Setup k3s services
  hosts: k3scontroller
  vars:
    k3s_release_version: v1.31.2+k3s1
    k3s_become: true
  tasks:
    - name: Check if k3s is installed
      ansible.builtin.command: k3s --version
      register: k3s_installed
      ignore_errors: true
      failed_when: false
      changed_when: false
    - name: Install k3s
      ansible.builtin.include_role:
        name: xanmanning.k3s
      vars:
        k3s_release_version: v1.31.2+k3s1
        k3s_server:
          cluster-cidr: 172.42.0.0/16
          service-cidr: 172.43.0.0/16
          cluster-dns: 172.43.0.10
      when: k3s_installed.rc != 0
    - name: Ensure kube folder exists
      ansible.builtin.file:
        path: "{{ home_dir }}/.kube"
        state: directory
        mode: "0744"
    - name: Copy k3s config for user
      become: true
      ansible.builtin.copy:
        src: /etc/rancher/k3s/k3s.yaml
        remote_src: true
        dest: "{{ home_dir }}/.kube/config"
        owner: "{{ ansible_user }}"
        mode: "0644"
        force: false

    - name: Install helm
      ansible.builtin.include_role:
        name: geerlingguy.helm
      vars:
        helm_version: v3.16.3
        helm_platform: linux
        helm_arch: "{{ ansible_architecture_alt }}"

    - name: Deploy the test k3s service
      ansible.builtin.include_role:
        name: "k3s_service"
      vars:
        k3s_service_name: assistant
        k3s_service_image: "ghcr.io/home-assistant/home-assistant:2024.10"
        k3s_service_container_port: 8123
        k3s_service_data_volume_mount_path: /config
        k3s_service_config_files:
          - template: "./resources/home-assistant/initial-configuration.yaml.j2"
            dest: "/config/configuration.yaml"
          - template: "./resources/home-assistant/empty-template.yaml.j2"
            dest: "/config/automations.yaml"
            init_only: true
          - template: "./resources/home-assistant/empty-template.yaml.j2"
            dest: "/config/scripts.yaml"
            init_only: true
          - template: "./resources/home-assistant/empty-template.yaml.j2"
            dest: "/config/scenes.yaml"
            init_only: true
